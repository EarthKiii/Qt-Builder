name: Qt-Builder

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  Building-Qt:
    runs-on: windows-latest
    steps:
    - name: Step 1 - Installing deps
      run: |
        echo "C:\ProgramData\Chocolatey\bin" >> $GITHUB_PATH
        choco upgrade chocolatey -y
        choco install git -y
        choco upgrade git -y
        echo "C:\ProgramData\chocolatey\lib\git\tools" >> $GITHUB_PATH
        echo "C:\ProgramData\chocolatey\lib\git" >> $GITHUB_PATH
        choco install strawberryperl -y
        choco upgrade strawberryperl -y
        echo "C:\ProgramData\chocolatey\lib\strawberryperl\tools" >> $GITHUB_PATH
        echo "C:\ProgramData\chocolatey\lib\strawberryperl" >> $GITHUB_PATH
        choco install mingw --version=11.2.0 -y --allow-downgrade
        choco upgrade mingw --version=11.2.0 -y --allow-downgrade
        echo "C:\ProgramData\chocolatey\lib\mingw\tools" >> $GITHUB_PATH
        echo "C:\ProgramData\chocolatey\lib\mingw" >> $GITHUB_PATH
        choco install llvm -y
        choco upgrade llvm -y
        echo "C:\ProgramData\chocolatey\lib\llvm\tools" >> $GITHUB_PATH
        echo "C:\ProgramData\chocolatey\lib\llvm" >> $GITHUB_PATH
        choco install cmake -y
        choco upgrade cmake -y
        echo "C:\ProgramData\chocolatey\lib\cmake\tools" >> $GITHUB_PATH
        echo "C:\ProgramData\chocolatey\lib\cmake" >> $GITHUB_PATH
        choco install ninja -y
        choco upgrade ninja -y
        echo "C:\ProgramData\chocolatey\lib\ninja\tools" >> $GITHUB_PATH
        echo "C:\ProgramData\chocolatey\lib\ninja" >> $GITHUB_PATH
        choco install python -y
        choco upgrade python -y
        echo "C:\ProgramData\chocolatey\lib\python\tools" >> $GITHUB_PATH
        echo "C:\ProgramData\chocolatey\lib\python" >> $GITHUB_PATH
        refreshenv
    - name: Step 2 - Checking deps version
      run: |
        echo "Path: $env:Path"
        echo "Choco: $(choco --version)"
        echo "Git: $(git --version)"
        echo "Cmake: $(cmake --version)"
        echo "Ninja: $(ninja --version)"
        echo "Perl: $(perl --version)"
        echo "Python: $(python --version)"
        echo "Mingw; $(gcc --version)"
    - name: Step 3 - Cloning Git
      run: git clone git://code.qt.io/qt/qt5.git qt6
    - name: Step 4 - Configuring Git
      run: git switch 6.5.1
      working-directory: qt6
    - name: Step 5 - Fetching sub-modules
      run: perl init-repository --module-subset=essential
      working-directory: qt6
    - name: Step 6 - Building Qt6.5.1
      run: | 
        mkdir qt6-build
        cd qt6-build
        tree ${{ github.workspace }}\qt6\bin
        ..\qt6\configure.bat -prefix ${{ github.workspace }}\Qt6.5.1
        cmake --build .
        cmake --install .
